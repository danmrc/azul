---
title: Usando clustering para identificar cursos no Prouni
author: Pedro Cavalcante
date: '2018-08-09'
slug: prouni-clustering
categories:
  - R
  - Clustering
  - Economia
tags:
  - Economia da Educação
  - R
  - Clustering
authors: []
draft: true
---

Você provavelmente conhece alguém que se formou no ensino médio e foi fazer um infame _cursinho_ pensando em uma aprovação numa graduação em Medicina. Pois é esperado, são cursos estranhamente competitivos e com as - de longe - maiores notas de corte. Por serem tão anômalos, podem ser um exercício interessante de classificação.

Vou expor brevemente a matemática por trás do processo de _Clustering k-means_, alguns problemas que surgem na hora de aplicar o algoritimo e aplica-lo em uma questão interessante de economia da educação, _carrer choice_. 

## O que é clustering?

Clustering é uma classe de algoritimos não-supervisionados para classificação de observações. Existem vários tipos, cores e tamanho de técnicas de clustering, mas essa bonita variedade vai ficar para outro dia porque o foco de hoje é a abordagem de distância centrada.

!["Agrupamento de observações"](https://i.imgur.com/S65Sk9c.jpg)

A visualização é razoavelmente clara, clusters são literalmente agrupamentos. Com base em alguns critérios dependentes do algoritimo a ser utilizado, você classifica uma observação em um _ou_ outro agrupamento (exceto nos modelos _fuzzy_, mas isso fica para outro dia).



## Clustering k-means como um problema de otimização

Um problema de otimização irrestrita tem, a grosso modo, dois _features_. A *função objetivo* a ser maximizada ou minimizada e o *instrumento* com o qual atingir tal objetivo. Aqueles familiarizados com o canônico método de estimação por Mínimos Quadrados Ordinários vão reconhecer alguma semelheança. 

K-means, ao invés de minimizar quadrado dos resíduos, minimiza a soma do quadrado da distância dentro do cluster (WCSS, em inglês). Nossos instrumentos são $k$, o número de agrupamentos e $S_i$, os conjuntos que dão qual elemento está em qual agrupamento. Podem parecer instrumentos redundantes à primeira vista. Pense que para um mesmo número de agrupamentos, é possível ter combinações de conjuntos com WCSSs diferentes.

Algumas definições antes. $k$ é o número de clusters, $S_i$ é conjunto de elementos do i-ésimo cluster, $\mu_i$ é a média do i-ésimo cluster.

$$ \text{arg min}_S \sum_{i=1}^k \sum_{x_j \in S_i} || x_j - \mu_i ||^2 $$

O leitor atento percebeu que $k$ não aparece aqui como um instrumento do problema, mas sim como um parâmetro dado. Bem, aí está uma das peculiaridades de k-means, _nós escolhemos o k_. É uma tarefa que tem um pouco de ciência e muita arte, vou me aprofundar um pouco nela mais à frente.

## Os dados

A amostra que temos é do ProUni de 2017 e conta com algo em torno de 32 mil observações. Já tive o trabalho de limpar a base para vossa apreciação e vou deixa-la disponível [aqui](https://github.com/danmrc/azul/tree/master/content/post/ProUni) e o código que contém tudo [aqui](https://github.com/danmrc/azul/blob/master/content/post/ProUni/prouni_cluster.R). Vamos primeiro explorar nossa amostra com a ajuda do ````ggplot2````.

```{r}
final %>%
ggplot(aes(x=prouni.mensalidade)) + 
  xlim(0,2500) +
  geom_histogram(aes(y=..density..), binwidth = 50) +
  xlab("Mensalidade do curso no ProUni") + 
  ylab("") +
  geom_density(colour =" medium blue", size = 1.5) +
  scale_y_continuous(labels = percent) +
  geom_vline(aes(xintercept=mean(prouni.mensalidade, na.rm=T)),   
             color="black", linetype="dashed", size=1)
             
 ````

!["Histograma das Mensalidades"](https://i.imgur.com/twn7b7n.png)

```{r}
final %>%
  ggplot(aes(x=prouni.mensalidade)) + 
  xlab("Mensalidade do curso no ProUni") + 
  ylab("") +
  geom_histogram(aes(y=..density..), binwidth = 300) +
  scale_y_continuous(labels = percent) +
  facet_wrap(~label) +
  geom_density(colour =" medium blue", size = 1)
````

!["Histograma das Mensalidades diferenciando cursos de Medicina"](https://i.imgur.com/14R87DN.png)

Os próximos dois gráficos tem códigos análogos aos dois anteriores e estão disponíveis no script. 

Aqui observamos três coisas muito interessantes. A primeira é que notas de corte seguem muito bem uma distribuição normal _exceto_ pela regra que impõe nota de corte mínima de 450 no ProUni e Sisu. É o tipo de coisa em que seria legal aplicar um [Teste de Densidade de McCrary (2006)](https://eml.berkeley.edu/~jmccrary/mccrary2006_DCdensity.pdf). Depois, que Medicina tem um padrão de distribuição de notas bem diferente do resto.

![Histograma das notas de corte](https://i.imgur.com/sipwjrG.png)

![Histograma das notas de corte diferenciando Medicina](https://i.imgur.com/EpBsTyV.png)

